<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>TI</title>
  
  </head>

  <link rel="stylesheet" href="./css/css-global.css"/>
  <link rel="stylesheet" href="./css/scan.css" />

  <body>

    <header>
      <a href="home.html"><img id="ConteudoLogo" src="logo.png" alt="Logo Jovens Gênios" ></a>

      <h2>Pesquisa TI</h2>
    <main>
      <div class="row">
        <div class="col">
          <div id="reader"></div>
        </div>
      </div>
    
      <h4>Código de Patrimônio</h4>
      <div class="col" style="padding: 30px">
        <div id="result"></div>
      </div>
  
      <h4>Insira o código de Patrimônio</h4>
      <input id="findID" type="text" />
      <button id="find" class="solid">Procurar</button>
    </header>


      <div id="dadosItens" >

        <h1>Dados dos Itens</h1>
    
        <h3 id="Item" type="text"></h3>
        <h3 id="Modelo" type="text"></h3>
        <h3 id="UserAtual" type="text"></h3>
        <h3 id="Armazenamento" type="text"></h3>
        <h3 id="CodigoDePatrimonioAntigo" type="text"></h3>
        <h3 id="CodigoDePatrimonioNovo" type="text"></h3>
        <h3 id="Estado" type="text"></h3>
        <h3 id="MemoriaRam" type="text"></h3>
        <h3 id="Nserie" type="text"></h3>
        <h3 id="Processador" type="text"></h3>
        <h3 id="SistemaOperacional" type="text"></h3>
        <h3 id="UserAnterior" type="text"></h3>
        <h3 id="CodCarregador" type="text"></h3>
        <h3 id="ValorCompra" type="float"></h3>
        <h3 id="DataCompra" type="text"></h3>
        <h3 id="Depreciacao" type="text"></h3>
        <h3 id="NotaFiscal" type="text"></h3>    
        <a id= "VisuNota" target="_blank" href=""><button>Visualizar Nota Fiscal</button></a>
        <h3 id="Obs" type="text"></h3>
        </div>
    </main>

    <footer>
      <div id="Buttons"> 
        <a class="solid" id="sair"><ion-icon name="exit" size="large"></ion-icon></a>
        <a href="add-db-brindes.html"><ion-icon name="add-circle" size="large"></ion-icon></a>
        <a href="home.html"><ion-icon name="arrow-back" size="large"></ion-icon></a>
      </div>
    </footer> 
    <script src="html5-qrcode.min.js"></script>
    <script src="scan.js"></script>
    <script type="module" async>
      import {
        auth,
        onAuthStateChanged,
        dbref,
        FindData,
      } from "./libs/firebase/index.js";

      import { 
        getMonths,
        calc,
        formatCurrency,
      } from "./utils/calcDepreciation.js";

      function redirectUser() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            
          } else {
            logout();
          }
        });
      }
      redirectUser();  //DESATIVADO PARA MELHOR TESTE

      

      var VisuNota = document.querySelector("#VisuNota");
      var ButtonNfe = document.querySelector("#ButtonNfe");
      var findItem = document.querySelector("#findItem");
      var result = document.querySelector("#ResultCod");
      var findID = document.querySelector("#findID");
      var find = document.querySelector("#find");
      var Item = document.querySelector("#Item");
      var Modelo = document.querySelector("#Modelo");
      var UserAtual = document.querySelector("#UserAtual");
      var Armazenamento = document.querySelector("#Armazenamento");
      var CodigoDePatrimonioAntigo = document.querySelector(
        "#CodigoDePatrimonioAntigo"
      );
      var CodigoDePatrimonioNovo = document.querySelector(
        "#CodigoDePatrimonioNovo"
      );
      var Estado = document.querySelector("#Estado");
      var MemoriaRam = document.querySelector("#MemoriaRam");
      var Nserie = document.querySelector("#Nserie");
      var Processador = document.querySelector("#Processador");
      var SistemaOperacional = document.querySelector("#SistemaOperacional");
      var UserAnterior = document.querySelector("#UserAnterior");
      var CodCarregador = document.querySelector("#CodCarregador");
      var ValorCompra= document.querySelector("#ValorCompra");
      var DataCompra = document.querySelector("#DataCompra"); 
      var Depreciacao = document.querySelector("#Depreciacao");
      var NotaFiscal = document.querySelector("#NotaFiscal");
      var Obs = document.querySelector("#Obs");
      var sair = document.querySelector("#sair");
      var item = document.querySelector("#item");

      function setData(item) {

        getMonths(item.DataCompra);
        calc(item.ValorCompra, item.DataCompra);        

        Item.innerHTML = "Item: " + item.Item;
        Modelo.innerHTML = "Modelo: " + item.Modelo;
        UserAtual.innerHTML = "Usuário Atual: " + item.UserAtual;
        Armazenamento.innerHTML = "Armazenamento: " + item.Armazenamento;
        CodigoDePatrimonioAntigo.innerHTML =
          "Código de Patrimônio Antigo: " + item.CodigoDePatrimonioAntigo;
        CodigoDePatrimonioNovo.innerHTML =
          "Código de Patrimônio Novo: " + item.CodigoDePatrimonioNovo;
        Estado.innerHTML = "Estado: " + item.Estado;
        MemoriaRam.innerHTML = "Memória Ram: " + item.MemoriaRam;
        Nserie.innerHTML = "Número de Série: " + item.Nserie;
        Processador.innerHTML = "Processador: " + item.Processador;
        SistemaOperacional.innerHTML =
          "Sistema Operacional: " + item.SistemaOperacional;
        UserAnterior.innerHTML =
          "Usuários Anteriores: " + item.UserAnterior;
        CodCarregador.innerHTML =
          "Carregador Usado: " + item.CodCarregador;
        ValorCompra.innerHTML =
          "Valor do item: " + formatCurrency(item.ValorCompra);
        DataCompra.innerHTML =
          "Data da Compra: " + item.DataCompra;
        Depreciacao.innerHTML =
          "Depreciação Atual: " + calc(item.ValorCompra, item.DataCompra);
        Obs.innerHTML = "Obs: " + item.Obs;    

        VisuNota.setAttribute("href", item.NotaFiscal);

        if (VisuNota != null) {
          
            VisuNota.style.display="flex";

        };
      }   
      
      async function onScanSuccess(qrCodeMessage) {
        document.getElementById("result").innerHTML =
          '<span class="result">' + qrCodeMessage + "</span>";
        const item = await FindData(qrCodeMessage);
        setData(item);
      }
      function onScanError(errorMessage) {
        //handle scan error
      }
      var html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250,
      });
      html5QrcodeScanner.render(onScanSuccess, onScanError);

      find.addEventListener("click", async () => {
        const item = await FindData(findID.value, "TI");
        setData(item);
        
      });

      function logout() {
      auth.signOut().then(() => {
          window.location.href = "index.html";
      }).catch(() => {
          alert('Erro ao fazer logout!')
    });
}

      sair.addEventListener("click", logout);
    </script>
  </body>
</html>
