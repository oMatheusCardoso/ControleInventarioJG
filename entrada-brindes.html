<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>Entrada de Brindes</title>
  
  </head>

  <link rel="stylesheet" href="./css/css-global.css"/>
  <link rel="stylesheet" href="./css/entrada-brindes.css"/>
  


  <body>
    <header>
      <a href="home.html"><img id="ConteudoLogo" src="logo.png" alt="Logo Jovens Gênios" ></a>
      <h1>Entrada de Brindes</h1>  
    </header>

    <main>  

    <div id="dadosItens">

    <h3 class="titulo">Dados dos Itens</h3>

    <img id="Imagem" class="Imagem_item" src="" alt="Imagem do Item"> 
    <h3 id="Item" type="text"></h3>    
    <h3 id="Tipo" type="text"></h3>
    <h3 id="Material" type="text"></h3>
    <h3 id="Arte" type="text"></h3>
    <h3 id="Quantidade" type="text"></h3>
    <h3 id="PrecoCompra" type="text"></h3>
    <h3 id="CustoProduto" type="text"></h3>
    <!-- <h3 id="PrecoVenda" type="text"></h3> -->
    <!-- <h3 id="DataCompra" type="text"></h3> -->
    <h3 id="Obs" type="text"></h3>
    <a id= "ImagemNotaFiscal" target="_blank" href="">Clique para visualizar ultima nota fiscal</a>

    </div>

    <form id="entrada">
      <h4>Preencha com as informações para Entrada</h4>
      <div class="item_forms">
        <label>Fornecedor: </label>
        <input type="text"  name="Fornecedor" id="Fornecedor" required>
      </div> 
      <div class="item_forms">
        <label>Data da Compra: </label>
        <input type="date"  name="DataCompraEntrada" id="DataCompraEntrada" required>
      </div> 
      <div class="item_forms">
        <label>Data da Entrega: </label>
        <input type="date"  name="DataEntregaEntrada" id="DataEntregaEntrada" required>
      </div> 
      <div class="item_forms">
        <label>Quantidade: </label>
        <input type="number"  name="QtdEntrada" id="QtdEntrada" min="1"  required >
      </div> 
      <div class="item_forms">
        <label>Valor Total: </label>
        <input type="number" step="0.1"  name="ValorTotalEntrada" id="ValorTotalEntrada" min="1"  required >
      </div> 
      <div class="item_forms">
        <label>Valor por unidade: </label>
        <input type="number" step="0.1"   name="ValorUnidadeEntrada" id="ValorUnidadeEntrada" min="1"  required >
      </div> 
      <div class="item_forms">
        <label>Obs: </label>
        <input type="text"  name="ObsEntrada" id="ObsEntrada" >
      </div> 
      <div class="item_forms">
        <label>Upload da Nota Fiscal: </label>
        <input type="file"  name="notaFiscalEntrada" id="notaFiscalEntrada" accept=".pdf, .jpg, .jpeg, .png" required>
      </div> 
      <input type="submit" id="enviarUpload" value="Finalizar Entrada">
    </form>

    </main>

    <footer>
      <div id="Buttons"> 
      <a class="solid" id="sair"><ion-icon name="exit" size="large"></ion-icon></a>
      <a class="solid" href="home.html"><ion-icon name="home" size="large"></ion-icon></a>
      <a class="solid" href="brindes.html"><ion-icon name="gift" size="large"></ion-icon></a>
      </div>
    </footer>

    <script
    type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>

    <script type="module" async>
      import {
        auth,
        onAuthStateChanged,
        dbref,
        FindData,
        addHistoryData,
        SetDataEntrada,
        refStorage,
        storage,
        uploadBytes
      } from "./libs/firebase/index.js";

      import { 
        getMonths,
        calc,
        formatCurrency,
      } from "./utils/calcDepreciation.js";

      function redirectUser() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
          } else {
            logout();
          }
        });
      }
      redirectUser();  

      var Tipo = document.querySelector("#Tipo");
      var Material = document.querySelector("#Material");
      var Arte = document.querySelector("#Arte");
      var Quantidade = document.querySelector("#Quantidade");
      var DataCompra = document.querySelector("#DataCompra");
      var ImagemNotaFiscal = document.querySelector("#ImagemNotaFiscal");
      var Obs = document.querySelector("#Obs");
      var find = document.querySelector("#find");
      var DataCompra = document.querySelector("#DataCompra");
      var Imagem = document.querySelector("#Imagem");	
      var PrecoCompra = document.querySelector("#PrecoCompra");	
      var CustoProduto = document.querySelector("#CustoProduto");	
      var PrecoVenda = document.querySelector("#PrecoVenda");	
      var enviarUpload = document.querySelector("#enviarUpload");
      var entrada = document.querySelector("#entrada");
      var notaFiscalEntrada = document.querySelector("#notaFiscalEntrada")
      var DataCompraEntrada = document.querySelector("#DataCompraEntrada")
      var DataEntregaEntrada = document.querySelector("#DataEntregaEntrada")

      function setData(item) {

        // getMonths(item.DataCompra);
        // calc(item.ValorCompra, item.DataCompra);

        Tipo.innerHTML = "Tipo: " + item.Tipo;
        Item.innerHTML = "Item: " + item.Item;
        Imagem.innerHTML = "Imagem: " + item.Imagem;        
        Material.innerHTML = "Material: " + item.Material;
        Arte.innerHTML = "Arte: " + item.Arte;
        Quantidade.innerHTML = "Quantidade: " + item.Quantidade;
        // PrecoCompra.innerHTML = "Preço de Compra: " + item.PrecoCompra;
        // CustoProduto.innerHTML = "Custo do Produto Finalizado: " + item.CustoProduto;
        // PrecoVenda.innerHTML = "Valor de Venda: " + item.PrecoVenda;
        // DataCompra.innerHTML = "DataCompra: " + item.DataCompra;
        // ImagemNotaFiscal.innerHTML ="NotaFiscal: " + item.VisuNota;
        Obs.innerHTML = "Obs: " + item.Obs;
        ImagemNotaFiscal.setAttribute("href", item.ImagemNotaFiscal);
        Imagem.setAttribute ("src", item.Imagem);

        if ((ImagemNotaFiscal || Imagem ) != null) {
          
            Imagem.style.display="flex";
            ImagemNotaFiscal.style.display="flex"; // Verificar se terá no app final, caso não tenha, retirar.

        };
        
      }

      var url = window.location.search;
      var idFromURL = new URLSearchParams(url);
      var URLid = idFromURL.get("id");

      DataCompraEntrada.max = new Date().toISOString().split("T")[0];
      DataEntregaEntrada.max = new Date().toISOString().split("T")[0];

      const item = await FindData(URLid, "Brindes");
        setData(item);
        

      entrada.addEventListener("submit", async () =>{
      event.preventDefault();

      let idAleatorio = Math.floor(Date.now() * Math.random()).toString(36);

      const notaFiscalfile = notaFiscalEntrada.files?.[0];
      console.log(notaFiscalfile);

      const uploadNotaFiscalRef = refStorage(storage, `Brindes/NotaFiscal/${idAleatorio}`);

      var urlNotaFiscal = (`https://firebasestorage.googleapis.com/v0/b/qrcodejg.appspot.com/o/Brindes%2FNotaFiscal%2F${idAleatorio}?alt=media&`);

      uploadBytes(uploadNotaFiscalRef, notaFiscalfile).then((snapshot) =>{

        console.log("Upload com sucesso!");
        alert("Entrada Efetuada");
        document.location.reload(true);
      
      });

      function listaEntrada(){

        let listaprenchida = {

        Tipo: "entrada",
        imagemBrinde: item.Imagem,
        tipoItem: item.Tipo ,
        dadosItem: item.Item ,
        Fornecedor: entrada.Fornecedor.value,
        DataCompraEntrada: entrada.DataCompraEntrada.value,
        QuantidadeAntes: item.Quantidade,
        QtdEntrada: entrada.QtdEntrada.value,
        ValorTotalEntrada: entrada.ValorTotalEntrada.value,
        ValorUnidadeEntrada: entrada.ValorUnidadeEntrada.value,
        ObsEntrada: entrada.ObsEntrada.value,
        notaFiscalEntrada: urlNotaFiscal,
        idUsuario: auth.currentUser.uid,
        emailUsuario: auth.currentUser.email,
        dataCompraUltima: item.DataCompra,
        antigaNF: item.ImagemNotaFiscal,
        novaNF: entrada.notaFiscalEntrada,
        data: new Date().toISOString()
        }
        return listaprenchida;
    }

    function calculo(){
      if (QtdEntrada !== 0){
        let q1 = parseInt(item.Quantidade);
        let q2 = parseInt(entrada.QtdEntrada.value);
        let calc = q1 + q2;
        return calc;
      } else {
        alert("Preencha a quantidade de entrada!")
      }
    
    }

    function attEntrada(){

      let attbrindesEntrada = {
        
        DataCompra: entrada.DataCompraEntrada.value,
        ImagemNotaFiscal: urlNotaFiscal,
        Quantidade: calculo(),
      }
      return attbrindesEntrada;
    }

    console.log(attEntrada);

      SetDataEntrada(item.Item, attEntrada());
      addHistoryData(listaEntrada(), "entrada", idAleatorio);

  }); 
      
      
      function logout() {
      auth.signOut().then(() => {
          window.location.href = "index.html";
      }).catch(() => {
          alert('Erro ao fazer logout!')
    });
}

      
      sair.addEventListener("click", logout);
    </script>
  </body>
</html>