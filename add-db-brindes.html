<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>Brindes</title>
  
  </head>

  <link rel="stylesheet" href="./css/css-global.css"/>
  <link rel="stylesheet" href="./css/add-db-brindes.css"/>


  <body>

    <header>
      <a href="home.html"><img id="ConteudoLogo" src="logo.png" alt="Logo Jovens Gênios" ></a>
      <h3>Adicionar item ao Estoque</h3>
    </header>
    


    
    <main>
    <form id="FormUpdate">
      <div class="formulario">
        <label>Item: </label>
        <br>
        <input type="text"  name="Item" id="Item" required>
      </div> 
      <div class="formulario">
        <label>Tipo: </label>
        <br>
        <input type="text"  name="Tipo" id="Tipo" required>
      </div> 
      <div class="formulario">
        <label>Material: </label>
        <br>
        <input type="text"  name="Material" id="Material" required>
      </div> 
      <div class="formulario">
        <label>Arte: </label>
        <br>
        <input type="text"  name="Arte" id="Arte" required>
      </div> 
      <div class="formulario">
        <label>Quantidade: </label>
        <br>
        <input type="number"  name="Quantidade" id="Quantidade" min="1" required>
      </div> 
      <div class="formulario">
        <label>Data da Compra: </label>
        <br>
        <input type="date" name="DataCompra" id="DataCompra" max="" required>
      </div> 
      <div class="formulario">
        <label>Obs: </label>
        <br>
        <input type="text" name="Obs" id="Obs">
      </div> 
      <div class="formulario">
        <label>Imagem da Nota Fiscal: </label>
        <br>
        <input type="file" name="uploadNotaFiscal"  id="uploadNotaFiscal" accept=".pdf, .jpg, .jpeg, .png" required>
      </div> 
      <div class="formulario">
        <label>Imagem do Item: </label>
        <br>
        <input type="file"  name="uploadImagem" id="uploadImagem" accept=".jpg, .jpeg, .png" required>
      </div>       
      <input type="submit" id="enviarUpload" >

    </form>

    </main>
    
    <footer>
      <div id="Buttons"> 
        <a class="solid" id="sair"><ion-icon name="exit" size="large"></ion-icon></a>
        <a class="solid" href="home.html"><ion-icon name="home" size="large"></ion-icon></a>
        <a class="solid" href="brindes.html"><ion-icon name="gift" size="large"></ion-icon></a>
        </div>

    </footer>

    <script
    type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script type="module" async>
      import {
        auth,
        onAuthStateChanged,
        dbref,
        FindData,
        SetData,
        getStorage,
        refStorage,
        storage,
        storageRef,
        uploadBytes,
        getDownloadURL,
        addHistoryData
      } from "./libs/firebase/index.js";

      import { 
        getMonths,
        calc,
        formatCurrency,
      } from "./utils/calcDepreciation.js";

      function redirectUser() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            
          } else {
            logout();
          }
        });
      }
      redirectUser();  //DESATIVADO PARA MELHOR TESTE

      var Tipo = document.querySelector("#Tipo");
      var Item = document.querySelector("#Item");
      var Material = document.querySelector("#Material");
      var Arte = document.querySelector("#Arte");
      var Quantidade = document.querySelector("#Quantidade");
      var DataCompra = document.querySelector("#Item");
      var VisuNota = document.querySelector("#Modelo");
      var Obs = document.querySelector("#Obs");
      var find = document.querySelector("#find");
      var DataCompra = document.querySelector("#DataCompra");
      var Imagem = document.querySelector("#Imagem");
      var ImagemNotaFiscal = document.querySelector("#ImagemNotaFiscal");
      var uploadNotaFiscal = document.querySelector("#uploadNotaFiscal");
      var uploadImagem = document.querySelector("#uploadImagem");
      var enviarUpload = document.querySelector("#enviarUpload")
      var FormUpdate = document.querySelector("#FormUpdate");
      var getURL = document.querySelector("#getURL");
      var sair = document.querySelector("#sair");

      DataCompra.max = new Date().toISOString().split("T")[0];
      
      FormUpdate.addEventListener("submit", (event) =>{
        event.preventDefault();   
        
        let idAleatorio = Math.floor(Date.now() * Math.random()).toString(36);

      const notaFiscalfile = uploadNotaFiscal.files?.[0];
      console.log(notaFiscalfile);
      const uploadNotaFiscalRef = refStorage(storage, `Brindes/NotaFiscal/${idAleatorio}`);
      var urlNotaFiscal = (`https://firebasestorage.googleapis.com/v0/b/qrcodejg.appspot.com/o/Brindes%2FNotaFiscal%2F${idAleatorio}?alt=media&`);
      
      uploadBytes(uploadNotaFiscalRef, notaFiscalfile).then((snapshot) =>{

        console.log("Upload com sucesso!");
      
      });

      const imagemBrindeFile = uploadImagem.files?.[0];
      console.log(imagemBrindeFile);
      const uploadImagemRef = refStorage(storage, `Brindes/ImagemBrindes/${idAleatorio}`);
      var urlBrindes = (`https://firebasestorage.googleapis.com/v0/b/qrcodejg.appspot.com/o/Brindes%2FImagemBrindes%2F${idAleatorio}?alt=media`);
      
      uploadBytes(uploadImagemRef, imagemBrindeFile).then((snapshot) =>{
        alert("Upload com sucesso!");
        document.location.reload(true);
      });

      function dadosDB() {     
        // PreçoDeCompra + CustoDoProdutoFinalizado + ValorDeVenda //Colocar depois essas informações em futuras versões
        var itensDB = {
        Item : FormUpdate.Item.value.toLowerCase().trim(),
        Imagem : urlBrindes,
        ImagemNotaFiscal : urlNotaFiscal,
        Tipo : FormUpdate.Tipo.value.toLowerCase().trim(),
        Material : FormUpdate.Material.value,
        Arte : FormUpdate.Arte.value,
        DataCompra : FormUpdate.DataCompra.value,
        Quantidade : FormUpdate.Quantidade.value,
        Obs : FormUpdate.Obs.value,
        
      }
      return itensDB;
      }

      SetData(Item.value, dadosDB());
      
      });

      function logout() {
      auth.signOut().then(() => {
          window.location.href = "index.html";
      }).catch(() => {
          alert('Erro ao fazer logout!')
    });
}

      sair.addEventListener("click", logout);

    </script>
  </body>
</html>